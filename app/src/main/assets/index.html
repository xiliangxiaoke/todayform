<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="./leaflet/leaflet.css" />
    <script src="./leaflet/leaflet.js"></script>
    <script src="./leaflet/chinaMapProvider.js"></script>
    <script src="./leaflet/Path.Drag.js"></script>
    <script src="./leaflet/Leaflet.Editable.js"></script>
    <script src="./leaflet/turf.min.js"></script>
    <title>Title</title>
</head>
<style>
    body {
        padding: 0;
        margin: 0;
    }
    html, body, #map {
        height: 100%;
        width: 100vw;
    }
</style>
<body>

<div id="map"></div>

<button onclick="test()">Copy Text</button>
<button onclick="test1()">Copy Text</button>
<button onclick="test2()">Copy Text</button>
</body>

<script>

    var farmlanddraw = null; // 用来存储绘制的农田
    var drawtype = "circle"; // circle polygon
    var cacheFeatures = []; // 用来存储已经加载的要素，供删除用

    var map = L.map('map', {
        center: [31.59, 120.29],
        zoom: 12,
        attributionControl: false,
        editable: true
    });

    map.zoomControl.setPosition('topright');

// 添加天地图
    L.tileLayer.chinaProvider('TianDiTu.Satellite.Map',{maxZoom:18,minZoom:5}).addTo(map);
    L.tileLayer.chinaProvider('TianDiTu.Satellite.Annotion',{maxZoom:18,minZoom:5}).addTo(map);



    //几何绘制编辑控件
    L.EditControl = L.Control.extend({

        options: {
            position: 'topleft',
            callback: null,
            kind: '',
            html: ''
        },

        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-control leaflet-bar'),
                link = L.DomUtil.create('a', '', container);

            link.href = '#';
            link.title = 'Create a new ' + this.options.kind;
            link.innerHTML = this.options.html;
            L.DomEvent.on(link, 'click', L.DomEvent.stop)
                      .on(link, 'click', function () {
                        window.LAYER = this.options.callback.call(map.editTools);
                      }, this);

            return container;
        }

    });





    // android 调用js的方法入口
    /***
        1 定位 {type:"location",params:{longitude:117,latitude:36}}
        2 绘制 {type:"draw",params:{action:"drawcircle|drawpolygon|getgeojson"}}
        3 显示边界 {type:"showgeo",params:{自定义的geogson，包含circle 和 polygon}}
        4 首页显示区划图 {type:"showallboundary",list:[]}
        5 首页显示健康监测图 {type:"showhealthimg",list:[]}
        6 首页显示影像图 {type:"showrsimg",list:[]}
        7 设置注记位置 {type:"notelocation",params:{lon:"",lat:""}}
    */
    function callJS(paraminfo){

        try{
            var paramobj = JSON.parse(paraminfo);
            // METHOD 定位地图位置
            if ("location" == paramobj.type) {
                map.panTo(paramobj.params);
            }else if("draw" == paramobj.type){
                doDraw(paramobj.params.action)
            }else if("showgeo" == paramobj.type){
                showfarmBoundary(paramobj.params)
            }else if("showallboundary" == paramobj.type){
                showallboundary(paramobj.list);
            }else if("showhealthimg" == paramobj.type){
                showHealthImg(paramobj.list)
            }else if("showrsimg" == paramobj.type){

            }
        }catch(e){
            var param = {
                    type:"error",
                    value:"aa"+e.name+" "+e.message


                };
            androidjs.call(JSON.stringify(param));
        }

    };

    /**
        在地图上显示所有的农田边界

    */
    function showallboundary(list){
        // 先删除已有的数据

        cacheFeatures.forEach(function (f){
            map.removeLayer(f);
        });

        cacheFeatures = [];

        list.forEach(function (info){

            para = info;

            if(para.geotype==='circle'){

                var circle = L.circle(para.center, {radius: para.radius}).addTo(map);
                cacheFeatures.push(circle);

            }else if(para.geotype==='polygon'){
                var polygon = L.polygon([para.coordinates], {color: 'red'}).addTo(map);
                cacheFeatures.push(polygon);
                // zoom the map to the polygon

            }

        });

        map.fitBounds(L.featureGroup(cacheFeatures).getBounds());



    }

    /**
        显示健康监测影像，可能有多个，都显示，并清除之前显示过的数据，然后适当居中
        //{"healthImgId":1,
        // "healthImgTime":"2018-10-27",
        // "fieldId":"402881e66671a1c9016671a4e57a0000",
        // "healthImgPath":"http://59.110.14.23:8070/jrnq/resource/health/health.jpg",
        // "healthImgLeft":23.0,
        // "healthImgRight":23.0,
        // "healthImgTop":23.0,
        // "healthImgBottom":23.0,
        // "fieldName":"农田名称2"}
    */
    function showHealthImg(list){

        // 先删除已有的数据

        cacheFeatures.forEach(function (f){
            map.removeLayer(f);
        });

        cacheFeatures = [];
        list.forEach(function (info){
            var imageUrl = info.healthImgPath,
            imageBounds = [[info.healthImgBottom, info.healthImgLeft], [info.healthImgTop, info.healthImgRight]];
            cacheFeatures.push(L.imageOverlay(imageUrl, imageBounds).addTo(map));

        });

        map.fitBounds(L.featureGroup(cacheFeatures).getBounds());
    }

    /**
        显示农田边界
        para: circle 和 polygon的结构体
    */
    function showfarmBoundary(para){
        if(para.geotype==='circle'){

            var circle = L.circle(para.center, {radius: para.radius}).addTo(map);
            map.fitBounds(circle.getBounds());
        }else if(para.geotype==='polygon'){
            var polygon = L.polygon([para.coordinates], {color: 'red'}).addTo(map);
            // zoom the map to the polygon
            map.fitBounds(polygon.getBounds());
        }
    }

    // 进行绘制操作
    /**
        drawcircle 绘制圆形
        drawpolygon 绘制多边形
        getgeojson 获取绘制结果
    */
    function doDraw(action){
        if("drawcircle" == action){
            drawtype = "circle";
            if(farmlanddraw){
                farmlanddraw.remove();
            }
            map.editTools.stopDrawing();
            farmlanddraw = map.editTools.startCircle();
        }else if("drawpolygon" == action){
            drawtype = "polygon";
            if(farmlanddraw){
                farmlanddraw.remove();
            }
            map.editTools.stopDrawing();
            farmlanddraw = map.editTools.startPolygon();
        }else if("getgeojson" == action){
            if(farmlanddraw){

                // js 调用android 传到前台 区分circle和polygon的结构  Geojson不直接支持circle，所以在外面又包了一层
                var geovalue;
                var area;
                if(drawtype == "circle"){
                    geovalue = {
                        geotype:"circle",
                        center: [farmlanddraw.getBounds().getCenter().lat,farmlanddraw.getBounds().getCenter().lng],
                        radius:farmlanddraw.getRadius()
                    };
                    area = getCircleArea(farmlanddraw.getRadius());
                }else if(drawtype == "polygon"){

                    var coors = [];
                    farmlanddraw.getLatLngs()[0].forEach(function (ll){
                        coors.push([ll.lat,ll.lng]);
                    });

                    geovalue = {
                        geotype:"polygon",
                        //geojson:farmlanddraw.toGeoJSON()
                        coordinates:coors
                    }
                    area = turf.area(farmlanddraw.toGeoJSON().geometry);
                }

                var param = {
                    type:"returngeojson",
                    value:""+JSON.stringify(geovalue),
                    farmarea:area
                }
                androidjs.call(JSON.stringify(param));
            }
        }
    }


    function getCircleArea(r){
        return r*r*Math.PI;
    }



//--------------------------test


//callJS('{"params":{"center":[31.601053,120.28519],"geotype":"circle","radius":4539.932},"type":"showgeo"}');

    function test(){

        var param = '{"type":"draw","params":{"action":"drawcircle"}}';
        callJS(param);
    }

    function test1(){

        var param = '{"type":"draw","params":{"action":"drawpolygon"}}';
        callJS(param);
    }

    function test2(){

        var param = '{"type":"draw","params":{"action":"getgeojson"}}';
        callJS(param);
    }

    
</script>

</html>